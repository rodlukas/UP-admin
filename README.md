<p align="center">
    <img src="./admin/static/admin/android-chrome-192x192.png" alt="√öPadmin logo" width="72">
</p>

<h3 align="center">√öPadmin</h1>

<p align="center">
    Web application for the project <strong><a href="https://uspesnyprvnacek.cz/">√öspƒõ≈°n√Ω prv≈à√°ƒçek</a></strong>.
</p>

<p align="center">
    <strong>Read this in other languages: <a href="README.md">English</a>, <a href="README.cs.md">Czech</a></strong>.
</p>

<p align="center">
    <a href="https://travis-ci.com/rodlukas/UP-admin"><img alt="Travis (.com)" src="https://img.shields.io/travis/com/rodlukas/UP-admin.svg?style=flat-square"></a>
    <a href="https://codecov.io/gh/rodlukas/UP-admin"><img alt="Codecov" src="https://img.shields.io/codecov/c/gh/rodlukas/UP-admin.svg?style=flat-square"></a>
    <a href="LICENSE"><img alt="GitHub license" src="https://img.shields.io/github/license/rodlukas/UP-admin.svg?style=flat-square"></a>
    <a href="https://github.com/rodlukas/UP-admin/releases/latest"><img alt="GitHub release" src="https://img.shields.io/github/release/rodlukas/UP-admin.svg?style=flat-square"></a>
    <a href="https://github.com/rodlukas/UP-admin/releases/latest"><img alt="GitHub commits since latest release" src="https://img.shields.io/github/commits-since/rodlukas/UP-admin/latest.svg?style=flat-square"></a>
    <br>
    <a href="https://lgtm.com/projects/g/rodlukas/UP-admin/alerts/"><img alt="LGTM Alerts" src="https://img.shields.io/lgtm/alerts/github/rodlukas/UP-admin.svg?style=flat-square"></a>
    <a href="https://lgtm.com/projects/g/rodlukas/UP-admin/context:javascript"><img alt="LGTM Grade" src="https://img.shields.io/lgtm/grade/javascript/github/rodlukas/UP-admin.svg?style=flat-square"></a>
    <a href="https://lgtm.com/projects/g/rodlukas/UP-admin/context:python"><img alt="LGTM Grade" src="https://img.shields.io/lgtm/grade/python/github/rodlukas/UP-admin.svg?style=flat-square"></a>
    <a href="https://observatory.mozilla.org/analyze/uspesnyprvnacek.herokuapp.com"><img alt="Mozilla HTTP Observatory Grade" src="https://img.shields.io/mozilla-observatory/grade-score/uspesnyprvnacek.herokuapp.com?publish&style=flat-square"></a>
    <a href="https://sonarcloud.io/dashboard?id=rodlukas_UP-admin"><img alt="Sonar Quality Gate" src="https://img.shields.io/sonar/quality_gate/rodlukas_UP-admin?server=https%3A%2F%2Fsonarcloud.io&style=flat-square"></a>
    <a href="https://deepscan.io/dashboard#view=project&tid=8194&pid=10346&bid=141965"><img src="https://deepscan.io/api/teams/8194/projects/10346/branches/141965/badge/grade.svg" alt="DeepScan grade"></a>
    <br>
    <a href="https://stackshare.io/rodlukas/upadmin"><img alt="StackShare" src="http://img.shields.io/badge/tech-stack-0690fa.svg?style=flat-square"></a>
    <a href="https://github.com/prettier/prettier"><img alt="Code style (js): prettier" src="https://img.shields.io/badge/code_style_(js)-prettier-ff69b4.svg?style=flat-square"></a>
    <a href="https://github.com/psf/black"><img alt="Code style (python): black" src="https://img.shields.io/badge/code_style_(python)-black-000000.svg?style=flat-square"></a>
    <br>
    <a href="https://uspesnyprvnacek.herokuapp.com/"><img alt="GitHub deployments" src="https://img.shields.io/github/deployments/rodlukas/UP-admin/uspesnyprvnacek?label=deploy%20%28production%29&style=flat-square"></a>
    <a href="https://uspesnyprvnacek-staging.herokuapp.com/"><img alt="GitHub deployments" src="https://img.shields.io/github/deployments/rodlukas/UP-admin/uspesnyprvnacek-staging?label=deploy%20%28staging%29&style=flat-square"></a>
    <a href="https://uspesnyprvnacek-testing.herokuapp.com/"><img alt="GitHub deployments" src="https://img.shields.io/github/deployments/rodlukas/UP-admin/uspesnyprvnacek-testing?label=deploy%20%28testing%29&style=flat-square"></a>
    <a href="https://uspesnyprvnacek-demo.herokuapp.com/"><img alt="GitHub deployments" src="https://img.shields.io/github/deployments/rodlukas/UP-admin/uspesnyprvnacek-demo?label=deploy%20%28demo%29&style=flat-square"></a>
</p>

<p align="center">
    <a href="https://sentry.io/organizations/rodlukas/issues/?project=1247206">Sentry</a> ¬∑ 
    <a href="https://dashboard.heroku.com/apps">Heroku</a> ¬∑ 
    <a href="https://uspesnyprvnacek.slack.com/messages">Slack</a> ¬∑ 
    <a href="https://analytics.google.com/analytics/web/#/report-home/a53235943w186065128p183124243">Google Analytics</a> ¬∑ 
    Logentries ‚Äì 
    <a href="https://addons-sso.heroku.com/apps/20c2c1b9-7573-42c9-ba22-cfdc7568f1f9/addons/551eb689-3908-4088-9100-519dfb42e836">production</a> / 
    <a href="https://addons-sso.heroku.com/apps/e3a9ca55-ccff-46ec-b37f-99ce57c75ee1/addons/f32bd464-be5c-4a70-bdbd-ca4b1c925803">staging</a> / 
    <a href="https://addons-sso.heroku.com/apps/20090cc9-a6a5-46f4-b6ff-516a1bb9ebf3/addons/398b1cfa-4aa4-499a-a3cd-300f2093c4b3">testing</a>
</p>

## Obsah

-   [Demo](#demo)
-   [Basic description of the app](#basic-description-of-the-app)
    -   [Key features](#key-features)
    -   [Used technologies](#used-technologies)
        -   [Backend](#backend)
        -   [Frontend](#frontend)
    -   [Deployed apps and tools](#deployed-apps-and-tools)
-   [Repository structure](#repository-structure)
-   [Run the app](#run-the-app)
    -   [Requirements](#requirements)
    -   [Installation](#installation)
    -   [Run](#run)
    -   [Testing](#testing)
-   [Screenshots](#screenshots)
-   [Licence](#licence)

## Demo

[**Deployed demo version of the app to Heroku**](https://uspesnyprvnacek-demo.herokuapp.com/) ‚Äì
login data: username `test` / password `test`.

> If an app receives no web traffic in a 30-minute period, it will sleep, after a short delay it
> will become active again. A database in the demo version is **automatically cleaned up** and
> filled with [sample data](scripts/sql/sample_data.pgsql).

## Basic description of the app

Web application for the project **[√öspƒõ≈°n√Ω prv≈à√°ƒçek](https://uspesnyprvnacek.cz/)** -- based on
techstack React (TypeScript), Django (Python), REST API, Django REST Framework.

The app was created in a **bachelors thesis at [FIT CTU](https://fit.cvut.cz/)** ‚Äì see a
[repo with text of the bachelors thesis](https://github.com/rodlukas/bachelors-thesis). Since then
the app is successfully used in the project [√öspƒõ≈°n√Ω prv≈à√°ƒçek](https://uspesnyprvnacek.cz/) on a
daily basis and is constantly extended and worked on ‚ù§Ô∏è. In 2020 within a **masters thesis at
[FIT CTU](https://fit.cvut.cz/)** I focused on all of the existing extension of the app by new
features, technologies and tools ‚Äì see a
[repo with text of the masters thesis](https://github.com/rodlukas/masters-thesis).

### Key features

In the following list there are the most important features offered by this app (the list is not
exhaustive):

-   **storing information about clients and group of clients attending the lectures of some
    course**,
-   **storing information about lectures of the clients and groups including the prepaid ones ‚Äì
    attendance state, payment, date, time, cancellation, notes**,
-   **keeping track of the applicants for the courses**,
-   **3 views for lectures: in a card of the client/group, diary and on the main page in today's
    overview**,
-   identifying time conflicting lectures,
-   automatic lecture cancellation for lectures without attendants,
-   automatic creation of the prepaid alternative lecture in case of the excuse or cancellation by
    the lecturer,
-   notification of the next lecture payment,
-   lecture number computation with respect to clients' attendances,
-   searching for clients (fuzzy searching)
-   course and attendance state configuration including e.g. an intuitive course color selection,
-   integration with the API of _Fio bank_ ‚Äì on the main page there is a pretty overview of the
    latest bank transactions,
-   automatic estimation of the course, date and time for the newly added lecture,
-   respecting and checking all the restrictions and limitations given by the domain (e.g.
    duplications),
-   keeping record of active and inactive clients and groups.

### Used technologies

The app is composed of the **frontend and backend** connected with a **REST API** secured using
**[JWT](https://jwt.io/) authentization**. [PostgreSQL 12](https://www.postgresql.org/) is used as a
database.

> **Note:** a part of this repo is dedicated to a deployment diagram and logical data model see
> [`docs/README.md`](docs).

#### Backend

Includes all the logic and exposes a **REST API** for a client, built on these technologies:

-   [Python 3.8](https://www.python.org/),
-   [Django 3](https://www.djangoproject.com/),
-   [Django REST framework 3](https://www.django-rest-framework.org/),
-   [djangorestframework-simplejwt](https://github.com/davesque/django-rest-framework-simplejwt),
-   [and more...](/Pipfile)

Django complex SQL queries are highly **optimized** (multiple times speed increase) (see articles
[[1]](https://www.revsys.com/tidbits/django-performance-simple-things/),
[[2]](http://ses4j.github.io/2015/11/23/optimizing-slow-django-rest-framework-performance/)).
**Advanced debugging** in a remote/local environment is offered thanks to
**[Django Debug Toolbar](https://github.com/jazzband/django-debug-toolbar)** and its plugin
[Django Debug Toolbar Request History](https://github.com/djsutho/django-debug-toolbar-request-history/).

**Static type checking** across the codebase based on type hints (module
[typing](https://docs.python.org/3/library/typing.html)), checking is done by
**[mypy](http://mypy-lang.org/)** and [Pycharm](https://www.jetbrains.com/pycharm/). **Dead code
elimination** is checked with **[vulture](https://github.com/jendrikseipp/vulture/)**.

#### Frontend

Responsive JS _([TypeScript](https://www.typescriptlang.org/))_ web app, specifically SPA
([Single-Page-App](https://en.wikipedia.org/wiki/Single-page_application)) built on these
technologies:

-   [React 16](https://reactjs.org/),
-   [Bootstrap 4](https://getbootstrap.com/) (with [Reactstrap](https://reactstrap.github.io/)),
-   [React Router 5](https://reacttraining.com/react-router/),
-   [FontAwesome 5 PRO](https://fontawesome.com/)
-   [a dal≈°√≠...](/frontend/package.json)

Main tools used for the frontend development:

-   [Webpack 4](https://webpack.js.org/) with custom configuration (local and production) +
    [Webpack DevServer](https://webpack.js.org/configuration/dev-server/),
-   [Babel 7](https://babeljs.io/),
-   [Typescript 3.8](https://www.typescriptlang.org/) ‚Äì static type checking,
-   [ESlint 6](https://eslint.org/) a [stylelint](https://stylelint.io/) ‚Äì linters for static code
    analysis
-   and [React Hot Loader](https://github.com/gaearon/react-hot-loader) ‚Äì for
    [HMR](https://webpack.js.org/guides/hot-module-replacement/).

The app is **resilient against JS errors** thanks to
**[React Error Boundaries](https://reactjs.org/docs/error-boundaries.html)**.
**[`React.lazy` + `React Suspense`](https://reactjs.org/docs/code-splitting.html)** are used for
**loading speed** of the whole app.
[Webpack DevServer](https://webpack.js.org/configuration/dev-server/) is integrated in development
phase with [Django](https://www.djangoproject.com/) dev server with all the related benefits
including [HMR](https://webpack.js.org/guides/hot-module-replacement/).

### Deployed apps and tools

The app is deployed to **4 PaaS [Heroku](https://www.heroku.com/) environments** varying in version
of the deployed app, database instance, debugging options and colors of the menu. Besides, the app
can be run in a local dev environment of course.

> **List of environments:**
>
> -   **dev (local)** ‚Äì for local development _(yellow menu)_,
> -   **testing** ‚Äì debugging mode can be turned on, each commit is deployed here _(blue menu)_,
> -   **staging** ‚Äì the same version as production, deploy of the releases _(green menu)_,
> -   **production** ‚Äì production version used by a customer, deploy of the releases (like staging)
>     _(white menu)_,
> -   [**demo**](https://uspesnyprvnacek-demo.herokuapp.com/) ‚Äì demo version of the app, manual
>     deploy from the `demo` branch.

-   Deployed apps are **HTTPS-only** (+ advanced security protection, see
    [[1]](https://docs.djangoproject.com/en/2.0/howto/deployment/checklist/),
    [[2]](https://wsvincent.com/django-best-practices/)).
-   [Automatic database backup](https://devcenter.heroku.com/articles/heroku-postgres-backups#scheduling-backups)
    is done at 3:00 (CET) in production env.
-   **Automatic code formatting** with **[Black](https://github.com/psf/black)** (Python) and
    **[Prettier](https://prettier.io/)** (TS, TSX, JS, CSS, HTML, JSON, YAML, TOML, MD), both the
    tools are integrated with IDE and perform automatic enhancements.
-   **The app are connected to more services:**
    -   **CI and CD** is taken care of by [Travis](https://travis-ci.com/) ‚Äì automated build,
        testing and deployment to various environments, automated execution of advanced scripts for
        e.g. automated app version addition to app, tokens handling, uploading static assets
        (frontend) to GitHub release assets, integration of cloud service for measuring code
        coverage etc.
    -   **Automated continuous code analysis** including code quality measure, finding zero-days and
        preventing critical vulnerabilities is taken care of by [LGTM](https://lgtm.com/),
        [SonarCloud](https://sonarcloud.io/) and [DeepScan](https://deepscan.io/).
    -   **Logs** from Heroku are sent to [Logentries](https://logentries.com/) (the logs are
        retained here for 7 days, sorted according to the environment).
    -   **Error monitoring of backend and frontend** including triage, notifications and integration
        with the repo is taken care of by [Sentry](https://sentry.io/) (sorted according to the
        environment, active on deployed apps). Integrated ability to collect **additional feedback
        upon hitting an error from user** thanks to the connection of Sentry and
        [React Error Boundaries](https://reactjs.org/docs/error-boundaries.html).
    -   **User flow analysis** thanks to the integration of
        [Google Analytics](https://analytics.google.com/) (via a module
        [react-ga](https://github.com/react-ga/react-ga)).
    -   [Slack](https://slack.com/)
-   Various **standards are enforced**: [PEP 8](https://pep8.org),
    [12-Factor App](https://12factor.net/), [ROCA](https://roca-style.org/).
-   Developed in IDE _[Pycharm (Professional Edition)](https://www.jetbrains.com/pycharm/)_ (takes
    care of automatic import optimization, automatic code formatting etc.).
-   _Complex tests of the API and UI (e2e)_ are an important part of the app, the tests are
    automatically run on the CI and can also be run in the local environment.
    -   Testing is built on a **BDD framework [behave](https://github.com/behave/behave)** ‚Äì testing
        scenarios are written using a natural language (Gherking), each of the test is run according
        to them.
    -   **UI (e2e) testing** is taken care of by [Selenium](https://github.com/SeleniumHQ/selenium).
    -   **Details about the tests are available in [`tests/README.md` (CZ)](tests)**.

## Repository structure

```bash
‚îú‚îÄ‚îÄ .idea ........ IDE settings (Pycharm from Jetbrains)
‚îú‚îÄ‚îÄ admin ........ Django app for the web app
‚îú‚îÄ‚îÄ api .......... Django app for the REST API
‚îú‚îÄ‚îÄ docs ......... additional docs and files for the app including diagrams
‚îú‚îÄ‚îÄ frontend ..... frontend part of the web app
‚îú‚îÄ‚îÄ scripts ...... scripts for the CI/CD/PaaS/installation
‚îú‚îÄ‚îÄ staticfiles .. directory for static files (empty, filled on the CI)
‚îú‚îÄ‚îÄ tests ........ tests of the API and UI (e2e)
‚îî‚îÄ‚îÄ up ........... entire Django project
```

## Run the app

There are two modes that the app can be run on the local dev environment, the default one is the
classic dev mode ‚Äì this mode includes advanced debugging tools, Django dev server and
webpack-dev-server for frontend are run. Since there is some work with private npm registry here
(see [below](#npmpro)), the frontend cannot be built without these tokens so that the alternative
way to run this app without these tokens is the second mode ‚Äì **manual production version of the
app**, it's also the closest one to the customer's version, this mode will be also run in this
tutorial.

### Requirements

Minimal requirements of tools available in the target OS:

-   [Python 3.8](https://www.python.org/downloads/) (for specific version see
    [`Pipfile`](/Pipfile)),
-   [Pipenv](https://docs.pipenv.org/en/latest/install/#installing-pipenv),
-   [Git](https://git-scm.com/downloads),
-   [PostgreSQL 12](https://www.postgresql.org/download/).

<a name="npmpro">
  
> **Note:** Node.js and NPM/Yarn are not required since the frontend cannot be built without tokens to private npm
 registry (for [FontAwesome PRO](https://fontawesome.com/)). Instead of this we'll use automatically generated assets 
 of the latest production version from the CI.
 
</a>

### Installation

Since the minimal requirements above are meet, you can follow these steps then:

1.  **Clone the repo**, open its folder and download **the latest production version** of the repo:

    ```bash
    git clone "https://github.com/rodlukas/UP-admin.git" && cd UP-admin
    git checkout $(git describe --tags `git rev-list --tags --max-count=1`)
    ```

2.  Download the **prepared assets for the frontend** from the latest production version and
    **unzip** them to the repo (and remove the `frontend.zip`):

    ```bash
    wget https://github.com/rodlukas/UP-admin/releases/latest/download/frontend.zip
    unzip frontend.zip && rm frontend.zip
    ```

3.  **Rename the sample config file `.env.template`** in the root to **`.env`**:

    ```bash
    mv .env.template .env
    ```

4.  Using the **[_psql CLI_](https://www.postgresql.org/docs/current/app-psql.html)** **we'll create
    the database and user** for the access to the database:

    ```bash
    sudo -u postgres psql -c "CREATE USER up WITH ENCRYPTED PASSWORD 'up';" -c "CREATE DATABASE up WITH OWNER up;"
    ```

5.  Download a **czech language pack for the database** (for czech alphabetic ordering):

    ```bash
    source scripts/shell/postgresql_cs.sh
    ```

6.  Install all the **backend requirements** and activate a virtual Python environment:

    ```bash
    pipenv install --dev
    pipenv shell
    ```

7.  **Prepare the Django app for run** ([skript](scripts/shell/release_tasks.sh) will set the
    default Django settings file, prepare the static frontend files and creates a database schema):

    ```bash
    source scripts/shell/release_tasks.sh
    ```

8.  Create an **user account for accessing the database** (choose some credentials that will be used
    for the login later):

    ```bash
    python manage.py createsuperuser
    ```

9.  üí° _(OPTIONAL)_ Finally you can also **fill the database with some
    [prepared sample data](scripts/sql/sample_data.pgsql)** that show some great features of the app
    out of the box and make the first experience enjoyable (the sample data includes some clients,
    groups, lectures, applicants, courses and attendance states) ‚Äì this script will require you to
    authenticate using the database credentials above (user `up` with the password `up`):

    ```bash
    psql --dbname up -h localhost -U up -f scripts/sql/sample_data.pgsql
    ```

### Run

**Run the dev server** üöÄ:

```bash
python manage.py runserver 0.0.0.0:8000
```

**‚úÖ The app is now available at <http://localhost:8000/>.**

> **Note: access the app from devices on the same network** ‚Äì the app is ready for use from other
> network devices (e.g. smartphone), usually there are two steps required to make this happen:
>
> 1.  allow Python and Node.js in a firewall (e.g. activate an interactive mode for ESET for a
>     while),
> 2.  type the hostname or private IP address of the computer running the server to your portable
>     device.

### Testing

Various tests of the app can be executed, e.g. test the API for clients:

```bash
python manage.py behave --stage=api --tags=clients
```

The repo contains **complex tests of the API and UI (e2e)** ‚Äì see the
[details about the tests and executing options (CZ)](tests).

## Screenshots

> **Note:** personal details are fictitious.

### Diary

[![screenshot from the diary](docs/screenshots/diary.png)](https://raw.githubusercontent.com/rodlukas/UP-admin/master/docs/screenshots/diary.png)

### Dashboard (main page)

[![screenshot from the dashboard](docs/screenshots/dashboard.png)](https://raw.githubusercontent.com/rodlukas/UP-admin/master/docs/screenshots/dashboard.png)

### Client's card

[![screenshot from the client's card](docs/screenshots/card.png)](https://raw.githubusercontent.com/rodlukas/UP-admin/master/docs/screenshots/card.png)

### Applications for courses

[![screenshot from the applications for course](docs/screenshots/applications.png)](https://raw.githubusercontent.com/rodlukas/UP-admin/master/docs/screenshots/applications.png)

### Settings

[![screenshot from the settings](docs/screenshots/settings.png)](https://raw.githubusercontent.com/rodlukas/UP-admin/master/docs/screenshots/settings.png)

## Licence

Licenced under the [MIT](LICENSE) licence.

Copyright (c) 2020 [Luk√°≈° Rod](https://lukasrod.cz/)
