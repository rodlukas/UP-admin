name: Build & Deploy

on:
    push:
        tags: ["*"]

env:
    ENVIRONMENT: CI-deploy
    SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
    GA4_ID: ${{ secrets.GA4_ID }}
    DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
    DJANGO_SETTINGS_MODULE: up.settings.production
    MANUAL_PRODUCTION: True
    SECRET_KEY: ${{ secrets.SECRET_KEY }}
    GPR_TOKEN: ${{ secrets.GPR_TOKEN }}
    REGISTRY: ghcr.io

jobs:
    build_and_deploy:
        name: Build & Deploy
        runs-on: ubuntu-22.04

        # github token opravneni pro upload k releasum/do container registru
        permissions:
            contents: write
            packages: write

        steps:
            # priprav prostredi
            - name: â˜ï¸ Checkout repo
              uses: actions/checkout@v6
            - name: ğŸ”§ Setup node
              uses: actions/setup-node@v6
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "**/package-lock.json"
            - name: ğŸ”§ Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"
                  cache: "pipenv"

            # spust skripty pro upravu souboru
            - name: ğŸ“ Create .npmrc file
              run: ./scripts/shell/ci/create_npmrc.sh
            - name: ğŸ“ Apply string substitution
              run: ./scripts/shell/ci/string_substitution.sh
            - name: ğŸ“ Create dummy .env file
              run: touch .env

            # nainstaluj JS zavislosti
            - name: ğŸ”§ JS - install deps & build frontend app
              run: npm ci

            # nainstaluj Python zavislosti
            - name: ğŸ”§ Python - install deps
              run: |
                  pip install pipenv
                  pipenv install --deploy --dev

            # priprav Django aplikaci
            - name: ğŸ”§ Python - build Django app (staticfiles)
              run: pipenv run python manage.py collectstatic --noinput

            # zabal frontend do zipu pro GH a nahraj
            - name: âœ¨ Pre-deploy tasks Github Releases
              run: ./scripts/shell/ci/create_frontend_zip.sh
            - name: ğŸš€ Upload build artifacts to GitHub Releases
              uses: softprops/action-gh-release@v2
              with:
                  files: frontend.zip
            - name: ğŸ§¹ Post-deploy tasks Github Releases
              run: ./scripts/shell/ci/remove_frontend_zip.sh

            # smazani dat z buildu, testovani a dokumentace
            - name: ğŸ§¹ Cleanup project folder
              run: ./scripts/shell/ci/cleanup.sh

            # nastavime spravnou fly.io konfiguraci
            - name: ğŸ§¹ Pre-deploy tasks Fly.io
              run: mv fly.prod.toml fly.toml

            # pripravime fly.io klienta pro deploy
            - name: ğŸ§¹ Pre-deploy tasks Fly.io - client
              uses: superfly/flyctl-actions/setup-flyctl@master

            # nasazeni prod verze na Fly.io
            - name: ğŸš€ Deploy to prod Fly.io
              if: ${{ github.actor != 'dependabot[bot]' }}
              run: flyctl deploy --remote-only
              env:
                  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_PROD }}

            # nahrani kontejneru s app do container registru
            - name: ğŸ”§ Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: ğŸ”§ Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ github.repository }}
            - name: ğŸš€ Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
